#include <stdint.h>
#include "serial.h"
#include "tools.h"
#include "kmain.h"

//get UART data and flag register at offset 0x0 and 0x18 (uart not memory)
volatile struct UART_DR *uartdr = (struct UART_DR *) 0x9000000;
volatile struct UART_FR *uartfr = (struct UART_FR *) 0x9000018;
volatile struct UARTLCR_H *uartlcr = (struct UARTLCR_H *) 0x900002c;
volatile struct UART_CR *uartcr = (struct UART_CR *) 0x9000030;

extern struct Info_header *infos;

void wait_unbusy(void)
{
    while(uartfr->fr_busy != 0)
    {
        continue;
    }
}

//send a uint8_t to the serial using the uartdr register
void putc(uint8_t c)
{
    if (c == '\n')
        putc('\r');
    uartdr->dr_data = c;
}

//print a string on serial
void puts(volatile char *str)
{
    for (uint32_t i = 0; str[i] != '\0'; i++)
    {
        if (str[i] == '\n')
            putc('\r');
        putc(str[i]);
    }
}

//get a uint8_t from the serial, get info from the uartdr register
uint8_t getc(void)
{
    wait_unbusy();
    while (uartfr->fr_rxfe == 1)
    {
        continue;
    }
    return uartdr->dr_data;
}

//print a unsigned integer on the serial
void putint(uint64_t nb)
{
    uint64_t count = 1;
    uint64_t saved = nb;
    if(nb == 0)
        putc('0');
    else
    {
        while(nb >= 10)
        {
            nb /= 10;
            count *= 10;
        }
        while(count > 0)
        {
            putc((saved/count) + 48);
            saved -= (saved/count)*count;
            count /= 10;
        }
    }
}

//1 = no zeros
void puthex(uint64_t nb, uint8_t padding_mode)
{
    uint64_t temp = 0;
    char arr[17] = "0000000000000000\0";
    uint8_t padded = 1;
    int8_t i = 0;


    if (nb == 0)
    {
        puts(arr);
        return;
    }

    if (nb <= 15)
        putc('0');


    while(nb > 0)
    {
        temp = nb % 16;
        if(temp < 10)
        {
            arr[i] = temp + 48;
            i += 1;
        }
        else
        {
            arr[i] = temp + 87;
            i += 1;
        }
        nb /= 16;
    }

    for(i = 15; i >= 0; i--)
    {
        if (padding_mode && padded && arr[i] == '0')
            continue;
        else if (padding_mode == 1)
        {
            putc(arr[i]);
            padded--;
        }
        else
        {
            putc(arr[i]);
        }
    }
}

//send a Image_file to the serial using the uartdr register
void Send_file(volatile uint8_t *p)
{
    uint64_t Image_size = infos->Image_size;
    while(Image_size > 0)
    {
        wait_unbusy();
        *p = uartdr->dr_data; //write the data obtained by the pyton script at p offset
        p++;                  
        Image_size--;
    }
}

void put_pika(void)
{
puts("\0    ⠀⠀⠀⠀⠀⠀   ⣴⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀    \n");
puts("⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣾⣿⣧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣾⣿⣿⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡾⠋⠉\033[0;33m⠀⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⠃⠀⠀⠀⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠀⠀⠀⠀⠀⠀⠀⠀⢀⡏⠀⠀⠀⠀⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠀⠀⠀⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣀⣀\033[0m⣠⣤⣤⣤⣤⠀⠀\033[0;33m\n");
puts("⠀⠀⠀⠀⠀⠀⠀⠀⡏⠀⠀⠀⠀⢸⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⡤⠴⠒⠊⠉⠉⠀⠀\033[0m⣿⣿⣿⠿⠋⠀⠀\033[0;33m\n");
puts("⠀⠀⠀⠀⠀⠀⠀⠀⡇⠀⠀⢀⡠⠼⠴⠒⠒⠒⠒⠦⠤⠤⣄⣀⠀⢀⣠⠴⠚⠉⠀⠀⠀⠀⠀⠀⠀⠀\033[0m⣼⠿⠋⠁\033[0;33m⠀⠀⠀⠀\n");
puts("⠀⠀⠀⠀⠀⠀⠀⠀⣇⠔⠂⠈⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢨⠿⠋⠀⠀⠀⠀⠀⠀⠀⠀⣀⡤⠖⠋⠁⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠀⠀⠀⠀⠀⠀⠀⢰⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⣠⠤⠒⠋⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠀⠀⠀⠀⠀⠀⢀⡟⠀\033[0m⣠⣄⡀\033[0;33m⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⢻⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣠⣤⣤⡤⠤⢴\n");
puts("⠀⠀⠀⠀⠀⠀⣸⠁\033[0m⣾⣿⣀⣽⡆⠀⠀⠀⠀⠀⠀⠀⢠⣾⠉⢿⣦\033[0;33m⠀⠀⠀⢸⡀⠀⠀⢀⣠⠤⠔⠒⠋⠉⠉⠀⠀⠀⠀⢀⡞\n");
puts("⠀⠀⠀⠀⠀⢀⡏⠀\033[0m⠹⠿⠿⠟⠁⠀⠰⠦⠀⠀⠀⠀⠸⣿⣿⣿⡿\033[0;33m⠀⠀⠀⢘⡧⠖⠋⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡼⠀\n");
puts("⠀⠀⠀⠀⠀⣼\033[91m⠦⣄⠀⠀\033[0m⢠⣀⣀⣴⠟⠶⣄⡀⠀⠀⡀⠀\033[0m⠉⠁\033[0;33m⠀⠀⠀⠀⢸⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⠁⠀\n");
puts("⠀⠀⠀⠀⢰\033[91m⡇⠀⠈⡇⠀⠀\033[0m⠸⡾⠁⠀⠀⠀⠉⠉⡏⠀⠀⠀\033[91m⣠⠖⠉⠓⢤\033[0;33m⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣰⠃⠀⠀\n");
puts("⠀⠀⠀⠀⠀⢧\033[91m⣀⡼⠃⠀⠀⠀\033[0m⢧⠀⠀⠀⠀⠀⢸⠃⠀⠀⠀\033[91m⣧⠀⠀⠀⣸\033[0;33m⢹⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡰⠃⠀⠀⠀\n");
puts("⠀⠀⠀⠀⠀⠈⢧⡀⠀⠀⠀⠀\033[0m⠘⣆⠀⠀⠀⢠⠏⠀⠀⠀⠀\033[91m⠈⠳⠤⠖⠃\033[0;33m⡟⠀⠀⠀⢾⠛⠛⠛⠛⠛⠛⠛⠛⠁⠀⠀⠀⠀\n");
puts("⠀⠀⠀⠀⠀⠀⠀⠙⣆⠀⠀⠀⠀\033[0m⠈⠦⣀⡴⠋⠀⠀⠀⠀⠀⠀⠀⠀\033[0;33m⢀⣼⠙⢦⠀⠀⠘⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠀⠀⠀⠀⠀⠀⠀⢠⡇⠙⠦⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣠⠴⠋⠸⡇⠈⢳⡀⠀⢹⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("  ⠀⠀⠀⠀⠀⡼⣀⠀⠀⠈⠙⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠀⠀⠀⠀⣷⠴⠚⠁⠀⣀⣷⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠀⠀⠀⠀⠀⠀⡴⠁⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣆⡴⠚⠉⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("\033[0m⣼⢷⡆\033[0;33m⠀⣠⡴⠧⣄⣇⠀⠀⠀⠀⠀⠀⠀⢲⠀⡟⠀⠀⠀⠀⠀⠀⠀⢀⡇⣠⣽⢦⣄\033[0m⢀⣴⣶\033[0;33m⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("\033[0m⡿⣼⣽\033[0;33m⡞⠁⠀⠀⠀⢹⡀⠀⠀⠀⠀⠀⠀⠈⣷⠃⠀⠀⠀⠀⠀⠀⠀⣼⠉⠁⠀⠀⢠\033[0m⢟⣿⣿⠁\033[0;33m⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("\033[0m⣷⠉⠁\033[0;33m⢳⠀⠀⠀⠀⠈⣧⠀⠀⠀⠀⠀⠀⠀⣻⠀⠀⠀⠀⠀⠀⠀⣰⠃⠀⠀⠀⠀⠏⠀⠀⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠹⡆⠀⠈⡇⠀⠀⠀⠀⠘⣆⠀⠀⠀⠀⠀⠀⡇⠀⠀⠀⠀⠀⠀⣰⠃⠀⠀⠀⠀⠀⠀⠀⣸⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠀⢳⡀⠀⠙⠀⠀⠀⠀⠀⠘⣆⠀⠀⠀⠀⠀⡇⠀⠀⠀⠀⠀⣰⠃⠀⠀⠀⠀⢀⡄⠀⢠⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠀⠀⢳⡀⣰⣀⣀⣀⠀⠀⠀⠘⣦⣀⠀⠀⠀⡇⠀⠀⠀⢀⡴⠃⠀⠀⠀⠀⠀⢸⡇⢠⠏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠀⠀⠀⠉⠉⠀⠀⠈⠉⠉⠉⠙⠻⠿⠾⠾⠻⠓⢦⠦⡶⡶⠿⠛⠛⠓⠒⠒⠚⠛⠛⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("=================================================\n");
puts("         WELCOME TO MY_PIKABOOT BOOTLOADER!!          \n\n\0");
}


void put_epika(void)
{
puts("\0    ⠀⠀⠀⠀⠀⠀   ⣴⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀    \n");
puts("⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣾⣿⣧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣾⣿⣿⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡾⠋⠉⠀⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⠃⠀⠀⠀⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠀⠀⠀⠀⠀⠀⠀⠀⢀⡏⠀⠀⠀⠀⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠀⠀⠀⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣀⣀⣠⣤⣤⣤⣤⠀⠀\n");
puts("⠀⠀⠀⠀⠀⠀⠀⠀⡏⠀⠀⠀⠀⢸⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⡤⠴⠒⠊⠉⠉⠀⠀⣿⣿⣿⠿⠋⠀⠀    \n");
puts("⠀⠀⠀⠀⠀⠀⠀⠀⡇⠀⠀⢀⡠⠼⠴⠒⠒⠒⠒⠦⠤⠤⣄⣀⠀⢀⣠⠴⠚⠉⠀⠀⠀⠀⠀⠀⠀⠀⣼⠿⠋⠁⠀⠀⠀⠀    \n");
puts("⠀⠀⠀⠀⠀⠀⠀⠀⣇⠔⠂⠈⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢨⠿⠋⠀⠀⠀⠀⠀⠀⠀⠀⣀⡤⠖⠋⠁⠀⠀⠀⠀⠀⠀⠀    \n");
puts("⠀⠀⠀⠀⠀⠀⠀⢰⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⣠⠤⠒⠋⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀    \n");
puts("⠀⠀⠀⠀⠀⠀⢀⡟⠀      ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⢻⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣠⣤⣤⡤⠤⢴  \n");
puts("⠀⠀⠀⠀⠀⠀⣸⠁ ⠀⠀⠀⠀⠀0        0       ⢸⡀  ⠀⠀⢀⣠⠤⠔⠒⠋⠉⠉⠀⠀⢀⡞\n");
puts("⠀⠀⠀⠀⠀⢀⡏⠀                        ⡧⠖⠋⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡼⠀\n");
puts("⠀⠀⠀⠀⠀⣼                         ⢸⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀ ⠀⠀⣸⠁⠀\n");
puts("⠀⠀⠀⠀⢰                          ⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀ ⠀⣰⠃⠀⠀\n");
puts("⠀⠀⠀⠀⠀⢧            ___         ⢹ ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡰⠃⠀⠀⠀\n");
puts("⠀⠀⠀⠀⠀⠈⢧⡀⠀⠀⠀⠀                 ⡟⠀⠀⠀⢾⠛⠛⠛⠛⠛⠛⠛⠛⠁⠀⠀⠀⠀\n");
puts("⠀⠀⠀⠀⠀⠀⠀⠙⣆⠀⠀⠀⠀             ⢀⣼⠙⢦⠀⠀⠘⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠀⠀⠀⠀⠀⠀⠀⢠⡇⠙⠦⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣠⠴⠋⠸⡇⠈⢳⡀⠀⢹⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("  ⠀⠀⠀⠀⠀⡼⣀⠀⠀⠈⠙⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠀⠀⠀⠀⣷⠴⠚⠁⠀⣀⣷⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠀⠀⠀⠀⠀⠀⡴⠁⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣆⡴⠚⠉⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⣼⢷⡆⠀⣠⡴⠧⣄⣇⠀⠀⠀⠀⠀⠀⠀⢲⠀⡟⠀⠀⠀⠀⠀⠀⠀⢀⡇⣠⣽⢦⣄⢀⣴⣶     ⠀⠀⠀⠀⠀⠀⠀\n");
puts("⡿⣼⣽⡞⠁⠀⠀⠀⢹⡀⠀⠀⠀⠀⠀⠀⠈⣷⠃⠀⠀⠀⠀⠀⠀⠀⣼⠉⠁⠀⠀⢠⢟⣿⣿⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⣷⠉⠁⢳⠀⠀⠀⠀⠈⣧⠀⠀⠀⠀⠀⠀⠀⣻⠀⠀⠀⠀⠀⠀⠀⣰⠃⠀⠀⠀⠀⠏⠀⠀⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠹⡆⠀⠈⡇⠀⠀⠀⠀⠘⣆⠀⠀⠀⠀⠀⠀⡇⠀⠀⠀⠀⠀⠀⣰⠃⠀⠀⠀⠀⠀⠀⠀⣸⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠀⢳⡀⠀⠙⠀⠀⠀⠀⠀⠘⣆⠀⠀⠀⠀⠀⡇⠀⠀⠀⠀⠀⣰⠃⠀⠀⠀⠀⢀⡄⠀⢠⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠀⠀⢳⡀⣰⣀⣀⣀⠀⠀⠀⠘⣦⣀⠀⠀⠀⡇⠀⠀⠀⢀⡴⠃⠀⠀⠀⠀⠀⢸⡇⢠⠏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("⠀⠀⠀⠉⠉⠀⠀⠈⠉⠉⠉⠙⠻⠿⠾⠾⠻⠓⢦⠦⡶⡶⠿⠛⠛⠓⠒⠒⠚⠛⠛⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
puts("=================================================\n");
puts("\n\n");
}

